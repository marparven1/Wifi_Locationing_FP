---
title: "Análisis exploratorio"
author: "Marta Venegas Pardo"
date: "3/8/2022"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE , warning = FALSE)
```

```{r}
library(dplyr)
library(kableExtra)

library(ggplot2)
library(plotly)

library(lubridate)

library(corrplot)
library(PerformanceAnalytics)
```


```{r}
# remove several unnecessary columns such as User ID, Phone ID and Timestamp.
```




```{r ,  lectura de datos}
load("Data_UJIndoorLoc/TrainingDataCleaned.RData")
dim(TrainingDataCleaned)
```
 




# Análisis descriptivo



Nuestro conjunto de datos tiene las siguientes dimensiones: `r dim(TrainingDataCleaned)`. De las 474 variables, 464 de ellas corresponden al valor de la intensidad de señal que llega al movil desde cada punto de acceso inalámbrico WAP y las otras 10 variables corresponden a posición desde donde se ha tomado la señal e identificación del usuario y teléfono móvil utilizado.


## Resúmenes descriptivos

Vamos a mostrar los datos a modo de tabla, pero únicamente mostraremos algunas de las variables WAP, ya que son demasiadas.


```{r}
DT::datatable(TrainingDataCleaned[,-c(7:464)])
```


- Formato de cada variable:


```{r}
TrainingDataCleaned[,-c(1:465)] %>% str()
```






En primer lugar, vamos a hacer un breve análisis descriptivo de las variables que no corresponden a las señales WAP.



```{r}
TrainingDataCleaned[,-c(1:465)] %>% summary()
```


## Gráficas



```{r}
# pairs(x=~LONGITUDE+LATITUDE+FLOOR+BUILDINGID+SPACEID+RELATIVEPOSITION+USERID+PH# ONEID   ,data=TrainingDataCleaned[,-c(1:465)])
# 
# TrainingDataCleaned[,-c(1:465)] %>% colnames()
```


### Visualización del campus 


```{r}
fig <- plot_ly(TrainingDataCleaned, y = ~LATITUDE, x = ~LONGITUDE, z = ~FLOOR, color = ~BUILDINGID)
fig <- fig %>% add_markers( size = 20 )
fig <- fig %>% layout(title = 'Representación de los edificios y plantas del campus',
  scene = list(
                     xaxis = list(title = 'LONGITUD'),
                     yaxis=list(title="LATITUD"),
                     zaxis = list(title = 'PLANTA')),
   annotations = list(text = 'ID del edificio'))

fig
```


### Análisis de los edificios

Encontramos 3 edificios y 5 plantas diferentes, pero eso no tiene porque indicar que todos los pisos tengan 5 plantas.

Es interesante destacar que la mayoría de mediciones se han tomado en el edificio con identificador 2 y en la posición relativa delante de la puerta, no dentro de las habitaciones.



```{r}
TrainingDataCleaned %>% select("FLOOR" | "BUILDINGID") %>% table()
```

En la tabla anterior observamos que el único edificio que tiene 5 plantas es el edificio número 2, y que los edificios 0 y 1 tienen 4 únicamente 5 plantas.




```{r}
ggplot(data=data.frame(
  BUILDINGID = 0:2 , 
  MEDICIONES = colSums(TrainingDataCleaned %>% select("FLOOR" | "BUILDINGID") %>% table())
), aes(x=BUILDINGID, y=MEDICIONES,fill=BUILDINGID)) + 
  scale_y_continuous(breaks = seq(0,7500,by=500) )+
    geom_bar(stat="identity", position="stack")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas en cada edificio")

```


Vemos como en el edificio 2 es en el que se han tomado mayor número de mediciones y podría ser debido a que es el que más plantas tiene.


```{r}
TrainingDataCleaned %>% select("FLOOR" | "BUILDINGID") %>% table()
```


```{r}
#dataf=data.frame(
#  BUILDINGID = c(rep(0:2, each=5)) , 
#  PLANTA = rep(0:4,3),
#  MEDICIONES = as.vector(TrainingDataCleaned %>% select("FLOOR" | "BUILDINGID") %>% table()) ) 
#
#ggplot(data=dataf, aes(x=BUILDINGID, y=MEDICIONES,fill=PLANTA) ) + 
#  scale_y_continuous(breaks = seq(0,7500,by=500) )+
#    geom_bar(stat="identity", position="dodge2")+ # position=position.stack se puede abreviar con #position="stack".
#labs(title = "Número de mediciones tomadas en cada edificio por plantas")

```


```{r}
ggplot(data=TrainingDataCleaned, aes(x=BUILDINGID,fill=FLOOR) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas en cada edificio por plantas")
```


Vemos que con gran diferencia, el edificio 2 es en el que mayor número de mediciones se han realizado.








### Análisis de los usuarios

```{r}
fig <- plot_ly(TrainingDataCleaned, y = ~LATITUDE, x = ~LONGITUDE,  color = ~USERID)
fig <- fig %>% add_markers()
fig <- fig %>% layout(title = 'Representación de los edificios según usuarios',
  scene = list(xaxis = list(title = 'LONGITUD'),
                     yaxis=list(title="LATITUD")),
   annotations = list(text = 'USER ID'))

fig
```

```{r}
fig <- plot_ly(TrainingDataCleaned, y = ~LATITUDE, x = ~LONGITUDE, z = ~FLOOR, color = ~USERID)
fig <- fig %>% add_markers()
fig <- fig %>% layout(title = 'Representación de los usuarios por edificios y plantas',
  scene = list(
                     xaxis = list(title = 'LONGITUD'),
                     yaxis=list(title="LATITUD"),
                     zaxis = list(title = 'PLANTA')),
   annotations = list(text = 'Usuario'))

fig
```

Observamos claramente como hay usuarios que suelen visitar edificios concretos, ya que la inmensa mayoría de los registros que hace son allí, como por ejemplo el usuario 11 en el edificio 0, aunque tambien visita las plantas 3 y 4 del edificio 2.


A continuación vamos a ver en que edificio ha registrado cada usuario el mayor número de visitas


```{r}

MaxRegistros <-data.frame(USERID = 1:18,count =  rep(NA,18),BUILDINGID =rep(NA,18) ) 
for (i in MaxRegistros[,1]) {
  df<-data.frame(TrainingDataCleaned %>% group_by(USERID,BUILDINGID) %>% summarise(REGISTROS= n()) %>% filter(USERID==i) )
  MaxRegistros[[i,2]]<- df[which.max(df[,3]),3]
  MaxRegistros[[i,3]]<- df[which.max(df[,2]),2]

}
MaxRegistros 
```


Número de medidas tomadas por cada usuario:

```{r}
Df <-data.frame(USERID = 1:18,count =  rep(NA,18)) 
for (i in Df[,1]) {
  Df[[i,2]]<-  TrainingDataCleaned %>% filter(USERID == i ) %>% nrow() 
}
# Df 


ggplot(data=TrainingDataCleaned ,
       aes(x=USERID,fill=USERID)) + 
    geom_bar(stat="count", position="dodge")+
  scale_y_continuous(breaks = seq(0,4000,200))+
labs(title = "Número de mediciones tomadas por cada usuario")

```

Vemos que hay un usuario en concreto que registra una cantidad de mediciones muy superior al resto, y este es el usuario número 11, con un total de 3703.


Número de mediciones tomadas por cada usuario en cada edificio


```{r}
ggplot(data=TrainingDataCleaned ,
       aes(x=USERID,fill=BUILDINGID)) + 
    geom_bar(stat="count", position="dodge")+
  scale_y_continuous(breaks = seq(0,2000,150))+
labs(title = "Número de mediciones tomadas en cada edificio por cada usuario")

```
Observamos que los únicos usuarios que han registrado posición en el edificio 0 son el 1 y el 11, pero cabe destacar que el usuario 11 también es el único que ha registrado señal en los tres edificios y el 1 únicamente en el edificio 0.

Conclusión: no todos los usuarios visitan todos los edificios.




#### Comentar gráfico

SEPARAR POR EDIFICIO, PLANTAS AISLADAS NO


```{r}
ggplot(data=TrainingDataCleaned %>% filter(BUILDINGID==0) ,
       aes(x=USERID, fill = FLOOR)) + 
    geom_bar(stat="count", position="dodge")+
  scale_y_continuous(breaks = seq(0,2000,150))+
labs(title = "Número de mediciones tomadas en el edificio 0 \n Por planta y usuario")

ggplot(data=TrainingDataCleaned %>% filter(BUILDINGID==1) ,
       aes(x=USERID, fill = FLOOR)) + 
    geom_bar(stat="count", position="dodge")+
labs(title = "Número de mediciones tomadas en el edificio 1 \n Por planta y usuario")


ggplot(data=TrainingDataCleaned %>% filter(BUILDINGID==2) ,
       aes(x=USERID, fill = FLOOR)) + 
    geom_bar(stat="count", position="dodge")+
labs(title = "Número de mediciones tomadas en el edificio 2 \n Por planta y usuario")
```

Vemos que la mayoría de individuos han tomado mediciones únicamente en una planta, aunque hayan visitado más de un edificio.



### Análisis de la posición relativa



Vamos a estudiar a continuación como ha variado el número de mediciones en función de la posición relativa de la toma.



```{r}

ggplot(data=TrainingDataCleaned, aes(x=RELATIVEPOSITION,fill=RELATIVEPOSITION) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas según la posición relativa")


ggplot(data=TrainingDataCleaned, aes(x=BUILDINGID,fill=RELATIVEPOSITION) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas en cada edificio" , subtitle =  "según la posición relativa")

```


Podemos observar como la mayoría de las mediciones han sido tomadas delante de la puerta, y son mucho menos las que han sido tomadas dentro de las habitaciones.


### Análisis del espacio 


Vamos a hacer un análisis de identificación de los espacios, y así poder ver si todos los edificios tienen los mismos espacios o se identifican unívocamente para cada edificio.

Identificación de los espacios según el edificio.

```{r}

Df_espacio<-
cbind.data.frame(BUILDINGID=c(rep(0,4),rep(1,4),rep(2,5)),
rbind.data.frame(
  TrainingDataCleaned %>%  filter(BUILDINGID==0) %>%   group_by(FLOOR,SPACEID ) %>%  summarize(n()) %>% group_by(FLOOR) %>% summarise(ESPACIOS=n()),

TrainingDataCleaned %>%  filter(BUILDINGID==1) %>%   group_by(FLOOR,SPACEID ) %>%  summarize(n()) %>% group_by(FLOOR) %>% summarise(ESPACIOS=n()),

TrainingDataCleaned %>%  filter(BUILDINGID==2) %>%   group_by(FLOOR,SPACEID ) %>%  summarize(n()) %>% group_by(FLOOR) %>% summarise(ESPACIOS=n())
)
)


ggplot(data=Df_espacio, aes(x=BUILDINGID,y=ESPACIOS,fill=FLOOR) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="identity", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
  scale_y_continuous(breaks = seq(0,85,by=5))+
labs(title = "Número de espacios diferentes según edificio y planta")


```


Aquí podemos ver el número de espacios que hay en cada edificio, y lo que nos hace pensar que no todos los edificios son igual de grandes, ya que el número de espacios del edificio 1 es inferior al resto, siendo el edificio 2 el que mayor número de espacios tiene, sobre todo en la planta 3.



¿Se repite el número de salas en función del edificio o cada edificio tiene sus propias salas?

```{r}
TrainingDataCleaned %>% select("SPACEID" | "BUILDINGID") %>% table()
```


Las salas de la 101 a la 122 se repiten para todos los edificios, sin embargo para el edificio 1, las salas de la 1 a la 30 son exclusivas de éste.

Las salas con identificadores 123-140 se repiten para los edificios 0 y 2, pero no existen (o no se han tomado registros) para el edificio 1.

```{r}
# ggplot(data=TrainingDataCleaned%>% filter(BUILDINGID==0 & FLOOR == 0), aes(x=SPACEID, # fill=SPACEID) ) + 
#  # scale_y_continuous(breaks = seq(0,3000,by=500) )+
#     geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con # position="stack".
# labs(title = "Número de mediciones tomadas en cada edificio por plantas")
```







### Análisis temporal


Vamos a estudiar como ha afectado la marca temporal a las mediciones y ver si podemos hacer alguna hipótesis




```{r}
ggplot(data=TrainingDataCleaned, aes(x=month , fill=month) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones según mes") + 
  scale_x_discrete("Mes", labels = c("5" = "Mayo","6" = "Junio") )+ 
  scale_y_continuous(breaks = seq(0,20000,by=1000))
```

Observamos, en primer lugar, que únicamente se han tomado mediciones en los meses de Mayo y Junio. Además, observamos que la mayoría de observaciones han sido tomadas en el mes de Julio, con un total de `r data.frame(TrainingDataCleaned %>% group_by(month) %>% summarise(n()) %>% select("n()"))[2,1]`, que supone un `r round(100*(data.frame(TrainingDataCleaned %>% group_by(month) %>% summarise(n()) %>% select("n()"))[2,1]/sum(data.frame(TrainingDataCleaned %>% group_by(month) %>% summarise(n()) %>% select("n()"))[,1] ) ),2)` % del total de mediciones. Por el contrario, en el mes de Mayo hubo un total de `r data.frame(TrainingDataCleaned %>% group_by(month) %>% summarise(n()) %>% select("n()"))[1,1]`

```{r}

ggplot(data=TrainingDataCleaned, aes(x=day , fill = month ) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas por meses según día") 
```


El motivo por el que la mayoría de mediciones se han tomado en el mes de Junio es que únicamente se han recogido mediciones los dos últimos días en el mes de Mayo, mientras que para Junio, se han recogido 4 días en total.


A continuación vamos a estudiar como varían las mediciones según el edificio:

```{r}
ggplot(data=TrainingDataCleaned, aes(x=month , fill = BUILDINGID) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas en cada edificio por meses") + 
  scale_x_discrete("Mes", labels = c("5" = "Mayo","6" = "Junio") )+  scale_y_continuous(breaks = seq(0,8000,by=500))
```

La mayoría de mediciones han sido tomadas en el edificio 2 y todas han sido tomadas en el mes de Junio. Cabe resaltar que en Mayo, únicamente se registran mediciones en el edificio 0.


A continuación vamos a ver como se distribuyen las mediciones según el edificio y por planta.

```{r}
ggplot(data=TrainingDataCleaned %>% filter(BUILDINGID==0), aes(x=month , fill = FLOOR) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas en el edificio 0",subtitle = "Por plantas") + 
  scale_x_discrete("Mes", labels = c("5" = "Mayo","6" = "Junio") )+  scale_y_continuous(breaks = seq(0,1000,by=100))

ggplot(data=TrainingDataCleaned %>% filter(BUILDINGID==1), aes(x=month , fill = FLOOR) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas en el edificio 1",subtitle = "Por plantas") + 
 scale_y_continuous(breaks = seq(0,1200,by=100))

ggplot(data=TrainingDataCleaned %>% filter(BUILDINGID==2), aes(x=month , fill = FLOOR) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas en el edificio 2",subtitle = "Por plantas") + 
 scale_y_continuous(breaks = seq(0,2300,by=100))
```

Vamos a comprobar como se distribuyen las mediciones según el día de la semana.


```{r}
ggplot(data=TrainingDataCleaned , aes(x=weekday , fill = weekday ) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas según día de la semana") +
    scale_x_discrete("Mes", labels = c("1" = "Lunes","2" ="Martes","3"="Miércoles","4"="Jueves","5"="Viernes") )
```



Observamos que únicamente se han tomado mediciones los días entre semana, y además, que la mayoría de ellas hansido tomadas los jueves.



```{r}
ggplot(data=TrainingDataCleaned, aes(x=weekday , fill = month ) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas según día de la semana y mes") +    scale_x_discrete("Mes", labels = c("1" = "Lunes","2" ="Martes","3"="Miércoles","4"="Jueves","5"="Viernes") )
```



De todas las mediciones, vemos que en el mes de mayo únicamente se tomaron mediciones los Jueves y Viernes.



```{r}
ggplot(data=TrainingDataCleaned, aes(x=hour , fill = month ) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas según hora del registro y mes") +    scale_x_discrete("Mes", labels = c("1" = "Lunes","2" ="Martes","3"="Miércoles","4"="Jueves","5"="Viernes") )
```

La distribución de las horas a las que se han tomado las medidas también varía de un mes a otro, ya que en el mes de Munio, la mayoría se han registrado en la franja horaria de 6 AM a 10 AM, mientras que en Mayo, muchas de las mediciones fueron a las 4 de la tarde.


Por último, comprobaremos como varía la toma de registros según el usuario que los ha tomado y por edificio.

```{r}
ggplot(data=TrainingDataCleaned %>% filter(BUILDINGID == 0), aes(x=weekday, fill = USERID ) ) + 
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas según día de la semana y usuario", subtitle = "Edificio 0") +   
  scale_x_discrete("Mes", labels = c("1" = "Lunes","2" ="Martes","3"="Miércoles","4"="Jueves","5"="Viernes") )

ggplot(data=TrainingDataCleaned %>% filter(BUILDINGID == 1), aes(x=weekday, fill = USERID ) ) + 
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas según día de la semana y usuario", subtitle = "Edificio 1") +   
  scale_x_discrete("Mes", labels = c("1" = "Lunes","2" ="Martes","3"="Miércoles","4"="Jueves","5"="Viernes") )

ggplot(data=TrainingDataCleaned %>% filter(BUILDINGID == 2), aes(x=weekday, fill = USERID ) ) + 
    geom_bar(stat="count", position="dodge2")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de mediciones tomadas según día de la semana y usuario", subtitle = "Edificio 0") +   
  scale_x_discrete("Mes", labels = c("1" = "Lunes","2" ="Martes","3"="Miércoles","4"="Jueves","5"="Viernes") )
```

Destacamos lo siguiente:

- En los edificios 1 y 2 únicamente se han registrado tomas de señal los jueves
- En el edificio 0 se registran tomas de señal todos los días entre semana, pero únicamente por dos usuarios que no registran tomas los mismos días y la mayoría de mediciones se han tomado los Miércoles por el usuario 1
- Hay usuarios como el usuario 4 que únicamente registran tomas de señal en el edificio 1 y ocurre lo mismo para los usuarios  5, 6 y 15 en el edificio 2.









### Distribución de los valores máximos y mínimos de señal

A continuación, vamos a representar la señal máxima detectada 

```{r}
ggplot(data=TrainingDataCleaned %>% filter(MaxSenal > -120), aes(x=MaxSenal ) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2", fill="#FF6666")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Valor de señal mínimo detectado") + 
  xlab("Valor de la intensidad de señal registrada (dBm)")+
  ylab("Num registros en la base de datos")+
  scale_x_continuous(breaks = seq(-125,0,by=5))+
  scale_y_continuous(breaks = seq(0,600,by=50))

sort(TrainingDataCleaned$MaxSenal )
```

Observamos que la máxima señal detectada que se repita más veces es para unos valores de intensidad de -58 y -61 dBm.

Además, es destacable que una intensidad de señal partir de -40 dBm se ha registrado como valor máximo muy pocas veces, destacando que el valor 0 se ha detectado hasta 50 veces.


Para la señal mínima:

```{r}
ggplot(data=TrainingDataCleaned , aes(x=MinSenal ) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2", fill="#FF6666")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Valor de señal mínimo detectado") + 
  xlab("Valor de la intensidad de señal registrada (dBm)")+
  ylab("Num registros en la base de datos")+
  scale_x_continuous(breaks = seq(-105,-60,by=5))+
  scale_y_continuous(breaks = seq(0,2000,by=100))
```

Los valores de intensidad de señal mínima corresponden a valores muy pobres, es decir, la señal era muy muy baja


```{r}
ggplot(data=TrainingDataCleaned , aes(x=NumWAP_Detectados ) ) + 
 # scale_y_continuous(breaks = seq(0,3000,by=500) )+
    geom_bar(stat="count", position="dodge2", fill="#FF6666")+ # position=position.stack se puede abreviar con position="stack".
labs(title = "Número de WAPS detectados") + 
  xlab("Nº WAPS detectados")+
  ylab("Num registros en la base de datos")+
  scale_x_continuous(breaks = seq(0,51,by=5))+
  scale_y_continuous(breaks = seq(0,1200,by=100))
```

Observamos que en muy pocas ocasiones se ha registrado señal en un único WAP y sin embargo, casi 1200 veces se ha detectado intensidad de señal en 15 WAPS a la vez. A partir de este valor anterior, el número de WAPS detectados al mismo tiempo en cada medición decrece considerablemente, y más aún a partir de los 21 WAPS detectados a la vez. 









## Correlación

Nota: El coeficiente de correlación es una medida que cuantifica la intensidad de la relación lineal entre dos varaibles, y por tanto, no tiene mucho sentido estudiar aquí este coeficiente, ya que no vamos a aplicar métodos de regresión para nuestras predicciones


```{r}
round(cor(TrainingDataCleaned[,1:411]),2)
```



